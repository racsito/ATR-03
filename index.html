<!DOCTYPE html>
<html lang="es">
<head>
  <!-- [Mantener todo el head original igual] -->
</head>
<body>
  <!-- [Mantener todo el HTML original igual] -->

<script>
  // =============================================
  // CONFIGURACIÓN GITHUB (REMPLAZA CON TUS DATOS)
  // =============================================
  const CONFIG = {
    TOKEN: localStorage.getItem('github_token') || prompt("Ingrese su token de GitHub:"),
    OWNER: "racsito",
    REPO: "atr-plc-data",
    BRANCH: "main",
    FILE: "data/atr-data.json"
  };

  // Guardar el token en localStorage para futuras sesiones
  if (CONFIG.TOKEN) localStorage.setItem('github_token', CONFIG.TOKEN);

  // =============================================
  // FUNCIONES MEJORADAS PARA GITHUB
  // =============================================
  async function ensureFileExists() {
    try {
      const url = `https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/${CONFIG.FILE}`;
      const response = await fetch(url, {
        headers: {
          'Authorization': `token ${CONFIG.TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      
      if (response.status === 404) {
        // El archivo no existe, lo creamos
        const initialContent = {
          nombrePLC: "ATR-34 PLC",
          numeroPLC: "00000000",
          pakbus: "000",
          ultimoMantenimiento: new Date().toLocaleDateString(),
          equipos: [],
          camposAdicionales: [],
          links: {
            certificado: "#",
            diagrama: "#",
            manual: "#",
            especificaciones: "#"
          }
        };
        
        await saveToGitHub(initialContent, true);
        console.log("Archivo creado exitosamente en GitHub");
      }
    } catch (error) {
      console.error("Error verificando archivo:", error);
    }
  }

  async function loadData() {
    try {
      await ensureFileExists();
      
      const url = `https://raw.githubusercontent.com/${CONFIG.OWNER}/${CONFIG.REPO}/${CONFIG.BRANCH}/${CONFIG.FILE}?t=${Date.now()}`;
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`Error ${response.status}`);
      }
      
      const data = await response.json();
      
      // Guardar copia local como respaldo
      localStorage.setItem('atr_local_backup', JSON.stringify(data));
      
      return data;
    } catch (error) {
      console.error("Error cargando datos:", error);
      
      // Intentar cargar desde el respaldo local
      const localBackup = localStorage.getItem('atr_local_backup');
      if (localBackup) {
        console.log("Cargando desde respaldo local");
        return JSON.parse(localBackup);
      }
      
      // Datos por defecto si todo falla
      return {
        nombrePLC: "ATR-34 PLC",
        numeroPLC: "00000000",
        pakbus: "000",
        ultimoMantenimiento: new Date().toLocaleDateString(),
        equipos: [
          "Rut xxxxxxxx",
          "campbell cr 310 xxxxxxx",
          "Conversor RS485 stm4855",
          "batería 12V 18Ah",
          "Controlador solar"
        ],
        camposAdicionales: [
          { nombre: "cota", valor: "1234 m" },
          { nombre: "nivel", valor: "2" }
        ],
        links: {
          certificado: "#",
          diagrama: "#",
          manual: "#",
          especificaciones: "#"
        }
      };
    }
  }

  async function saveToGitHub(data, isInitialCreate = false) {
    try {
      let sha = null;
      
      if (!isInitialCreate) {
        sha = await getFileSHA();
      }

      const url = `https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/${CONFIG.FILE}`;
      const body = {
        message: `Actualización ${new Date().toISOString()}`,
        content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))),
        branch: CONFIG.BRANCH
      };
      
      if (sha) body.sha = sha;

      const response = await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${CONFIG.TOKEN}`,
          'Content-Type': 'application/json',
          'Accept': 'application/vnd.github.v3+json'
        },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        throw new Error(await response.text());
      }
      
      // Actualizar el respaldo local
      localStorage.setItem('atr_local_backup', JSON.stringify(data));
      
      return true;
    } catch (error) {
      console.error("Error guardando:", error);
      throw error;
    }
  }

  async function getFileSHA() {
    try {
      const url = `https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/${CONFIG.FILE}`;
      const response = await fetch(url, {
        headers: {
          'Authorization': `token ${CONFIG.TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      const data = await response.json();
      return data.sha;
    } catch (e) {
      return null;
    }
  }

  // =============================================
  // MANEJO DE DATOS EN LA INTERFAZ
  // =============================================
  let appData = {};
  let modoEdicion = false;

  async function initApp() {
    try {
      // Mostrar mensaje de carga
      document.getElementById('nombre-plc').textContent = "Cargando...";
      
      // 1. Cargar datos
      appData = await loadData();
      
      // 2. Mostrar en la interfaz
      updateUI();
      
      // 3. Configurar eventos
      document.getElementById('btn-save').onclick = guardarCambios;
      document.getElementById('btn-toggle-edit').onclick = toggleModoEdicion;
      document.getElementById('btn-export').onclick = exportarAExcel;
      
      console.log("Datos cargados correctamente:", appData);
    } catch (error) {
      console.error("Error inicializando:", error);
      alert("Error al cargar los datos. Ver consola para detalles.");
    }
  }

  function updateUI() {
    // Actualizar todos los campos
    document.getElementById('nombre-plc').textContent = appData.nombrePLC;
    document.getElementById('numero-plc').textContent = appData.numeroPLC;
    document.getElementById('pakbus').textContent = appData.pakbus;
    document.getElementById('ultimo-mantenimiento').textContent = appData.ultimoMantenimiento;
    
    renderizarEquipos(appData.equipos);
    renderizarCamposAdicionales(appData.camposAdicionales);
    
    // Actualizar enlaces
    for (const [key, url] of Object.entries(appData.links)) {
      const btn = document.getElementById(`btn-${key}`);
      if (btn) btn.href = url;
    }
  }

  async function guardarCambios() {
    const clave = prompt("Contraseña para guardar:");
    if (clave !== "ceneris2020") {
      alert("Contraseña incorrecta");
      return;
    }

    try {
      // 1. Recoger datos actuales de la UI
      appData = {
        nombrePLC: document.getElementById('nombre-plc').textContent,
        numeroPLC: document.getElementById('numero-plc').textContent,
        pakbus: document.getElementById('pakbus').textContent,
        ultimoMantenimiento: document.getElementById('ultimo-mantenimiento').textContent,
        equipos: obtenerEquipos(),
        camposAdicionales: obtenerCamposAdicionales(),
        links: appData.links
      };

      // 2. Guardar en GitHub
      await saveToGitHub(appData);
      alert("✅ Datos guardados correctamente");
    } catch (error) {
      alert(`❌ Error al guardar: ${error.message}`);
    }
  }

  // [Mantener todas las funciones de renderizado iguales que antes...]
  // renderizarEquipos(), editarCampo(), etc...

  // Iniciar la app cuando se cargue la página
  window.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>

