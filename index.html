<script>
  // =============================================
  // CONFIGURACIÓN GITHUB (REMPLAZA ESTOS VALORES)
  // =============================================
  const GITHUB_TOKEN = "ghp_tu_token_de_github"; // ¡No lo subas a GitHub!
  const REPO_OWNER = "tu_usuario_github";        // Ej: "juanperez"
  const REPO_NAME = "tu_repositorio";            // Ej: "atr-plc-data"
  const BRANCH = "main";

  // =============================================
  // FUNCIONES PARA GITHUB
  // =============================================
  async function saveToGitHub(data) {
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/data/atr-data.json`;
    
    // 1. Obtener SHA del archivo existente (si hay)
    let sha = null;
    try {
      const response = await fetch(url, {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      const fileInfo = await response.json();
      sha = fileInfo.sha;
    } catch (e) {
      console.log("Creando archivo por primera vez...");
    }

    // 2. Configurar el cuerpo de la solicitud
    const body = {
      message: "Actualización desde ATR-PLC App - " + new Date().toISOString(),
      content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
      branch: BRANCH,
      sha: sha
    };

    // 3. Enviar datos
    const response = await fetch(url, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      throw new Error(`Error ${response.status}: ${await response.text()}`);
    }
    return await response.json();
  }

  async function loadFromGitHub() {
    const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/atr-data.json?t=${Date.now()}`;
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error("Archivo no encontrado");
      return await response.json();
    } catch (error) {
      console.error("Error cargando datos:", error);
      return null;
    }
  }

  // =============================================
  // APLICACIÓN PRINCIPAL (MODIFICADA PARA GITHUB)
  // =============================================
  let modoEdicion = false;
  const links = {
    certificado: "#",
    diagrama: "#",
    manual: "#",
    especificaciones: "#"
  };

  async function initApp() {
    const data = await loadFromGitHub();
    
    if (data) {
      // Cargar datos desde GitHub
      document.getElementById('nombre-plc').innerText = data.nombrePLC || 'ATR-66 PLC';
      document.getElementById('numero-plc').innerText = data.numeroPLC || '959312882';
      document.getElementById('pakbus').innerText = data.pakbus || '784';
      document.getElementById('ultimo-mantenimiento').innerText = data.ultimoMantenimiento || '15/06/2025';
      
      renderizarEquipos(data.equipos || [
        "Rut xxxxxxxx",
        "campbell cr 310 xxxxxxx",
        "Conversor RS485 stm4855",
        "batería 12V 18Ah",
        "Controlador solar"
      ]);

      renderizarCamposAdicionales(data.camposAdicionales || [
        { nombre: "cota", valor: "1234 m" },
        { nombre: "nivel", valor: "2" }
      ]);

      if (data.links) {
        Object.assign(links, data.links);
        for (let key in links) {
          document.getElementById(`btn-${key}`).href = links[key];
        }
      }
    } else {
      // Datos por defecto si GitHub falla
      showDefaultData();
    }
  }

  function showDefaultData() {
    document.getElementById('nombre-plc').innerText = 'ATR-66 PLC';
    document.getElementById('numero-plc').innerText = '959312882';
    document.getElementById('pakbus').innerText = '784';
    document.getElementById('ultimo-mantenimiento').innerText = '15/06/2025';
    renderizarEquipos([
      "Rut xxxxxxxx",
      "campbell cr 310 xxxxxxx",
      "Conversor RS485 stm4855",
      "batería 12V 18Ah",
      "Controlador solar"
    ]);
    renderizarCamposAdicionales([
      { nombre: "cota", valor: "1234 m" },
      { nombre: "nivel", valor: "2" }
    ]);
  }

  // =============================================
  // FUNCIONES DE INTERFAZ (IGUALES AL ORIGINAL)
  // =============================================
  function toggleModoEdicion() {
    modoEdicion = !modoEdicion;
    document.querySelectorAll(".edit-btn, .del-btn").forEach(btn =>
      btn.classList.toggle("visible", modoEdicion)
    );
    
    const addEquipoBtn = document.getElementById("add-equipo-btn");
    const addCampoBtn = document.getElementById("add-campo-btn");
    if (addEquipoBtn) addEquipoBtn.style.display = modoEdicion ? "inline" : "none";
    if (addCampoBtn) addCampoBtn.style.display = modoEdicion ? "inline" : "none";

    if (modoEdicion) {
      for (let key in links) {
        document.getElementById("btn-" + key).onclick = function (e) {
          e.preventDefault();
          const nuevo = prompt(`Ingrese el enlace para ${key}:`, links[key]);
          if (nuevo && nuevo.trim().startsWith("http")) {
            links[key] = nuevo.trim();
            e.target.href = links[key];
          }
        };
      }
    } else {
      for (let key in links) {
        const btn = document.getElementById("btn-" + key);
        btn.onclick = null;
        btn.href = links[key];
      }
    }
  }

  function editarCampo(id) {
    const el = document.getElementById(id);
    const nuevo = prompt("Editar valor:", el.innerText);
    if (nuevo !== null && nuevo.trim() !== "") {
      el.innerText = nuevo;
    }
  }

  function renderizarEquipos(lista) {
    const ul = document.getElementById("lista-equipos");
    ul.innerHTML = "";
    lista.forEach((texto, i) => {
      const li = document.createElement("li");
      li.innerHTML = `${texto}
        <button class="edit-btn" onclick="editarEquipo(${i})">✏️</button>
        <button class="del-btn" onclick="eliminarEquipo(${i})">🗑️</button>`;
      ul.appendChild(li);
    });

    const liAdd = document.createElement("li");
    liAdd.innerHTML = `<button id="add-equipo-btn" class="add-btn" onclick="agregarEquipo()" style="display:none;">➕ Agregar equipo</button>`;
    ul.appendChild(liAdd);
  }

  function editarEquipo(index) {
    const items = obtenerEquipos();
    const nuevo = prompt("Editar equipo:", items[index]);
    if (nuevo !== null && nuevo.trim() !== "") {
      items[index] = nuevo;
      renderizarEquipos(items);
    }
  }

  function eliminarEquipo(index) {
    if (confirm("¿Eliminar este equipo?")) {
      const items = obtenerEquipos();
      items.splice(index, 1);
      renderizarEquipos(items);
    }
  }

  function agregarEquipo() {
    const nuevo = prompt("Nuevo equipo:");
    if (nuevo && nuevo.trim() !== "") {
      const items = obtenerEquipos();
      items.push(nuevo);
      renderizarEquipos(items);
    }
  }

  function obtenerEquipos() {
    return Array.from(document.querySelectorAll("#lista-equipos li"))
      .slice(0, -1)
      .map(li => li.childNodes[0].nodeValue.trim());
  }

  function renderizarCamposAdicionales(campos) {
    const container = document.getElementById("campos-adicionales");
    container.innerHTML = "";
    
    campos.forEach((campo, index) => {
      const div = document.createElement("div");
      div.className = "additional-field";
      div.innerHTML = `
        <span class="label">${campo.nombre}:
          <span class="value" id="campo-${index}-valor">${campo.valor}</span>
          <button class="edit-btn" onclick="editarCampoAdicional(${index})">✏️</button>
          <button class="del-btn" onclick="eliminarCampoAdicional(${index})">🗑️</button>
        </span>
      `;
      container.appendChild(div);
    });
    
    const addBtn = document.createElement("button");
    addBtn.id = "add-campo-btn";
    addBtn.className = "add-btn";
    addBtn.style.display = "none";
    addBtn.onclick = agregarCampoAdicional;
    addBtn.textContent = "➕ Agregar campo";
    container.appendChild(addBtn);
  }

  function editarCampoAdicional(index) {
    const campos = obtenerCamposAdicionales();
    const nuevoNombre = prompt("Editar nombre del campo:", campos[index].nombre);
    if (nuevoNombre === null) return;
    
    const nuevoValor = prompt("Editar valor:", campos[index].valor);
    if (nuevoValor === null) return;
    
    campos[index] = {
      nombre: nuevoNombre || campos[index].nombre,
      valor: nuevoValor || campos[index].valor
    };
    
    renderizarCamposAdicionales(campos);
  }

  function eliminarCampoAdicional(index) {
    if (confirm("¿Eliminar este campo?")) {
      const campos = obtenerCamposAdicionales();
      campos.splice(index, 1);
      renderizarCamposAdicionales(campos);
    }
  }

  function agregarCampoAdicional() {
    const nombre = prompt("Nombre del nuevo campo:");
    if (!nombre || nombre.trim() === "") return;
    
    const valor = prompt("Valor del campo:");
    if (valor === null) return;
    
    const campos = obtenerCamposAdicionales();
    campos.push({
      nombre: nombre.trim(),
      valor: valor || ""
    });
    
    renderizarCamposAdicionales(campos);
  }

  function obtenerCamposAdicionales() {
    const campos = [];
    const elementos = document.querySelectorAll("#campos-adicionales .additional-field");
    
    elementos.forEach((el, index) => {
      const nombre = el.querySelector(".label").textContent.split(":")[0];
      const valor = document.getElementById(`campo-${index}-valor`).textContent;
      campos.push({ nombre, valor });
    });
    
    return campos;
  }

  // =============================================
  // FUNCIÓN PARA GUARDAR CAMBIOS EN GITHUB
  // =============================================
  async function guardarCambios() {
    const clave = prompt("Ingrese la contraseña para guardar los cambios:");
    if (clave === null || clave.trim() !== "ceneris2020") {
      alert("❌ Contraseña incorrecta");
      return;
    }

    const data = {
      nombrePLC: document.getElementById('nombre-plc').innerText,
      numeroPLC: document.getElementById('numero-plc').innerText,
      pakbus: document.getElementById('pakbus').innerText,
      ultimoMantenimiento: document.getElementById('ultimo-mantenimiento').innerText,
      equipos: obtenerEquipos(),
      camposAdicionales: obtenerCamposAdicionales(),
      links: links
    };

    try {
      await saveToGitHub(data);
      alert("✅ Datos guardados en GitHub correctamente!");
    } catch (error) {
      console.error("Error:", error);
      alert("❌ Error al guardar: " + error.message);
    }
  }

  // =============================================
  // EXPORTAR A EXCEL (FUNCIÓN ORIGINAL)
  // =============================================
  function exportarAExcel() {
    const nombrePLC = document.getElementById("nombre-plc").innerText;
    const numeroPLC = document.getElementById("numero-plc").innerText;
    const ultimoMantenimiento = document.getElementById("ultimo-mantenimiento").innerText;
    const pakbus = document.getElementById("pakbus").innerText;
    const equipos = obtenerEquipos();
    const camposAdicionales = obtenerCamposAdicionales();
    
    const datos = [
      ["ATR", "Valor"],
      ["Nombre PLC", nombrePLC],
      ["Número PLC", numeroPLC],
      ["Último mantenimiento", ultimoMantenimiento],
      ["PakBus", pakbus],
      ["", ""],
      ["Equipos instalados", ""],
      ...equipos.map(equipo => ["", equipo]),
      ["", ""],
      ["Campos adicionales", ""],
      ...camposAdicionales.map(campo => [campo.nombre, campo.valor])
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(datos);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Datos ATR");
    XLSX.writeFile(wb, `${nombrePLC.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  // Iniciar la aplicación
  window.onload = initApp;
</script>
